// Change Log

2013-10-04
  itemsinfo.php
    added 'Show' after each site name. When page first renders only the site headings are displayed
    with a 'Show' button. When the button is clicked the daily info is displayed and another button
    that says 'Show More'. If 'Show More' is clicked then the additional information is displayed.
    This make the page much less cluttered and you can select only the sites you want to view. 

2013-10-05
  emailphoto.php
    Changed the log output to be more readable.

  cpanel-v1.06/cpanel.approve.js
    image.width = $("#"+id).attr('width'); // img width from approvephotos in cpanel.ajax.php
    before it had a hard coded value of 300.

  videocontrol.php
    no change just touched the file by mistake.

2013-10-06
  emailphoto.php
    Continue some tunning of the emailphoto.log format.
  
  index.php
    1) The ajax:clearlog now copies the log to {$logfile}.save before emptying the logfile.
    The 'unit=' on the URL is set to the unix epoch time as provided by 'new Date.getTime()' which
    provides the unix epoch in milliseconds. Also if the index is invoced as a 'user' the 'unit'
    is set to 'unit=user' plus the user's id and then a space and the unix epoch. The makes sure that
    the unit is unique for all invocations of slideshow.
    2) Added support for non superusers. If not a superuser then asks for the 
    users email address and password (from 'users' table), then show a reduced version of the page
    with the siteCode and siteId filled in.
    The 'unit' is filled in with the unix time as reported by new Date.getTime() which has milsec.
    3) Added superuser welcome.
    4) Added if 'usercheck' on URL then do the check for user logic.
    5) Added welcome to the superuser by name.
    6) As a result of changing the 'unit' to varchar(50) in the 'startup' table the unit in the
    'Site Status' table at the top of the index page and the 'trackstartup.php' page is blank if
    no 'unit=' is on the URL.
    7) Changed the 'Site Status' table to be only today and 'order by' Last. Also removed 'ID'.
    8) Changed the ajax:gettable to do close logic after 30 minutes. Also all of the table logic is
    now in the ajax function not in the javascript.
    9) Added a 'Show All' button to the 'Site Status'. Initially we only show open sites. When the 
    button is pushed we then show all sites for the day and change the button to 'Show Only Open'.
    10) Added info about the cpanel symlink right under the slideshow symlink info at the top of the
    page.
    11) Added 'users Table Info' (userinfo.php) Displays the 'users' table.

    !!!NOTE: the email address in users can be for more than one site so we need to do a while and give
    the user a choice if he is on more than one site. In general this is only the case for the 
    superusers so I don't know if it is worth the trouble.

  siteInfo.php
    Added logic so only superusers can access it.

  userinfo.php
    Created User Info.

  trace-startup.php
    Changed the ajax:gettable to do close logic after 30 minutes. Also all of the table logic is
    now in the ajax function not in the javascript. We sort by lasttime just like in index.php.

  SQL: tables bingogames and startup
    changed the 'unit' from int(11) to varchar(50). 

  /includes/SiteClass.class.php
    Modified getFooter() to show last modified time the same as index.php and in red if newer than
    three days.

  videocontrol.php, js/videocontrol.js
    Added a 'Select' status so we don't show everything all the time. We start by showing the active
    videos. If you select another status then only those are shown. When 'Submit Ads Changes' or
    'Submit Items Changes' is selected that section is refreshed.

2013-10-07
  SQL users table
    Added 'textNotify' to table.
    Changed default for status to 'admin'.

  cpanel-v1.06 (cutting edge): cpanel.account.php, js/cpanel.account.js
    Rework the layout of the account page. Change it to have only one 'Submit' button.
    Add emailNotify and textNotify.

  cpanel-v1.06 (cutting edge): js/cpanel.newuser.js
    Fix return to account page. Previously is was returning and then going right back to newuser.
    I am not sure why the previous method didn't work -- oh well.

2013-10-08
  webstats.php
    Add buttons to each table to Show/Hide.
    Changed logip/logagent to just logagent and removed the left join. Added group by agent,ip.

  .sitemap.php
    siteinfo => 'users' added back. see Tom.class.php below.

  include/SiteClass.class.php
    private function tableUpdate($q1, $q2) to  protected function tableUpdate($q1, $q2). To support
    override in Tom.class.php below.

  include/Tom.class.php
    Added tracker() to override base class tracker. We don't update the memberTable's visits or 
    visittime but we do memberpagecnt and the this.id is valid now for the logip and logagent tables.
    (REVERSED on 2013-10-09)

  userinfo.php
    Added emailNotify, textNotify and password to the sql query.

  index.php
    Added logic to code with users that are in more than one site.
    Added logic to set the user id via $S->setId(). 
    For superuser I added two special users 3 and 4 for site SU-[superuser number]. The superuser gets 
    one of these userId numbers.

  SQL users table
    added users 3 and 4 for me and Tom to work with change above in index.php.

2013-10-09
  index.php
    1)Seperated out the Javascript into js/index.js and the css into css/index.css. This makes the
    index.php less cluttered.
    2) If there are no closed sites in the startup table we don't show the show/hide button. If there
    are closed sites we show "Open=n, Closed=n <button>".
    3) Added logic to set the userId 

  cpanel-v1.06/cpanel.top.php
    Added some comments.
    Add logic to set userId.

  SQL users table
    Added two fields 'approved' and 'approvedtime' to be used by cpanel.approved instead of visits and 
    visittime.
    This will undo a lot of the changes I made on 10-8.

  include/Tom.class.php
    Removed changed made on 10/8

  include/SiteClass.class.php
    Changed logic in checkId and tracker.

  SQL logip and logagent
    Altered the primary key to include 'id'.

  cpanel-v1.06/cpanel.approve.js
    Changed visits to approved and visittime to approvedtime. See SQL above.

  slideshow-v1.07/slideshow.php
    Added logic to set the SideClass $this->id to either the unitId on the URL or zero (not the cookie).
  
2013-10-10
  cpanel-v1.06/cpanel.php
    Added $siteId = $S->siteId; Cpanel.top.php does not set $siteId, $superuser or $userId any more.
    $siteId is only used in cpanel.php and the other two are never used. Cpanel.top.php sets the
    Javascript variables siteId, superuser and userId via the $S properties above.

  cpanel-v1.06/cpanel.top.php
    It was only touched to do debugging no actual changes were made.

2013-10-11
  emailphoto.php
    Added logic to emailphoto.php to use textNotify and emailNotify!

2013-10-12
  index.php
    Moved "Create A New Site" to bottom of list just above "Delete A Site". Changed some wording.
    Added divs for 'cutting-slideshow' and 'cutting-cpanel'. Added button 'Show Rename Table' to 
    show/hide the table that has the files that have been renamed.

  whoapproved.php
    Changed it to use 'approved' and 'approvedtime'.

  emailphoto.php
    Added logic to remove blank lines from the $msgBody:
    $msgBody = preg_replace("/\n+\s*\n/", "\n", $msgBody);

  cpanel-v1.06/cpanel.top.php and cpanel.php
    The previous fix 2013-10-10 was not enough. Added $siteId=$S->siteId into cpanel.top.php and
    removed it from cpanel.php. All the cpanel.xxx.php files use $siteId on the return to cpanel.php.
    I think this fixes it NOW.

2013-10-14
   siteautoload.php
     Changed the terible 'if' tree into an array lookup. Looks much nicer.

   All of the following were changed to use includes/myphotochannelbanner.i.php:
   index.php/index.css, adsAccountAdmin.php, uploadsforweek.php, adsadmin.php, userinfo.php,
   videocontrol.php, webstats.php, createNewSite.php, whoapproved.php, track-startup.php,
   deleteSite.php and siteInfo.php.
     These all have this added:
     $s->bannerFile = SITE_INCLUDES."/myphotochannelbanner.i.php";
     $S = new Tom($s);
     The $h->banner changed to only have the <h1> title stuff that goes into $mainTitle in 
     SiteClass.class.php.
     Add the style stuff for the header removed.
     itemsInfo.php, uploadads.php and uploadphotos.php use cpanel/cpanel.top.php so they use the new
     setBannerFile() method in Tom.class.php.
     itemsTableMaint.php does not yet have a header.

   includes/Tom.class.php
     Added method setBannerFile() to allow the bannerFile property of SiteClass.class.php to be set
     after instantiation.

2013-10-18
  slideshow-v1.07/slideshow.ajax.php
    Added siteId to the pusher messages for slideshow.
    Added set status='open' to startup-update in getItem().
    
2013-10-20
  slideshow-v1.07/slideshow.ajax.php
    Added ip and agent to pusher messages.

  pushercheck.php
    New. Monitors the 'slideshow' channel and displays all events.

  index.php
    Removed some text in the cutting edge section.

2013-10-21
  siteautoload.php
    Changes to make it conform more closely to what I use at lamphost.net.

  emailphoto.php
    Removed logic that set $_SERVER["DECUMENT_ROOT"], this is now done by the siteautoload.php.

  slideshow-v1.07/photoloto.php
    Removed logic that set $_SERVER["DECUMENT_ROOT"], this is now done by the siteautoload.php.
    Added logic to set $siteautoload.
    Made the same changes to:
      slideshow-v1.06/photoloto.php  
      slideshow-v1.05/photoloto.php  
      slideshow-v1.04/photoloto.php

  index.php
    Added siteautoload.php and .sitemap.php to list at bottom.

  cpanel-v1.06/cpanel.ajax.php
    Added 'startup' and 'unload' to update the startup table and send Pusher messages.

  cpanel-v1.06/js/cpanel.js
    Added logic to do ajax calls 'startup' and 'unload'.

  .sitemap.php
    Only added comments.

  SQL startup table
    deleted everything starting fresh. The next time one of the sites starts up we will see something 
    until then blank.

TODO
  Add another pusher call in emailphoto.php when I send the email.
  SiteId, user, photos added.

2013-10-22
  slideshow-v1.07/iframe-test.php
    Demos a slideshow and cpanel iframe on a page. 
    Have not added it to index.php yet.

2013-10-24
  cpanel-v1.06/js/cpanel.js
    Added function sendstartupupdate() to do an ajax call to update the startup lasttime.

  cpanel-v1.06/cpanel.ajax.php
    Added startup-update ajax function to update the startup table's lasttime and then do a Pusher
    call.

  All CLI programs. Made sure that the setting of $_SERVER['DOCUMENT_ROOT'] has been removed.
  mkmlbschedule-image.php and mkmlbschedule.php still had the code -- removed it and tested.

2013-10-25
  index.php
    Change SideShow to SlideShow in the cutting edge area.

2013-10-30
  Created cpanel-v1.08 (skipped v1.07 so cpanel and slideshow would be at same level)
  Created slideshow-v1.08
  v1.08 will support the new feature: if you submit a picture then 3 of your other photos will become
  features also.

  SQL added showTime to 'items' table. 

  SQL added featureExt (feature extend) to 'sites' table.

  cpanel-v1.08/cpanel.ajax.php and cpanel-v1.08/cpanel.approve.js
    Added logic to use showTime.
    Added logic to use featureExt.

2013-10-31
  emailphoto.php
    Added showTime=now() to insert.

2013-11-03
  slideshow-v1.08/slideshow.ajax.php
    Changed creationTime to showTime.

  slideshow-v1.08/js/slideshow.js
    Change some comments to reflect the change from creationTime to showTime. All the real work 
    happens in slideshow.ajax.php above.

  cpanel-v1.08/cpanel.ajax.php
    Add some comments reference showTime vs creationTime.

  cpanel-v1.08/cpanel.approve.js
    Change doSql query in case 'approvephotosOK':
      the ext variable now looks like "no" or "<type>,<days before now>,<limit>,<days before now>"
      that is <type>=chron|rand, <more recent than>, <limit>, <less recent than>

  SQL sites
    No change to schema but the fetureExt has new meaning as above. Set Site-Demo to:
    rand,30,3,1 which means random select between -30 days and -1 day.

  cpanel-v1.08/cpanel.showsettings.php and js/cpanel.showsettings.js
    Added 'Feature Extend'

2013-11-05
  index.php
    Fixed 'Show All' button. Now it doesn't change back to 'Show All' everytime getTable() is called.

  slideshow-v1.08/slideshow.ajax.php
    Fixed getAds. I had changed creationTime to showTime but the ads table does not have showTime yet.
    Use the new fields (see below) from appinfo.

  SQL appinfo
    copied allowAds, allowVideo, playbingo, playLotto and featureExt to appinfo. I have left them in
    sites for now so I don't break backward compatibility.

  slideshow-v1.08/js/slideshow.js
    Changes to use new values from appinfo (see above).

  cpanel-v1.08/cpanel.ajax.php, cpanel-v1.08/js/cpannel.showsettings.js and js.cpannel.games.js
    Changes to use new values from appinfo.

  cpanel-v1.08/itemInfo.php
    Changes to use new values from appinfo. 

  cpanel-v1.08/cpanel.top.php
    Change to function debug() if $noselect is true. We return normal() not start().

  itemsTableMaint.php
    Added showTime to sql insert.

  uploadphotos.php
    Added showTime to sql insert.

  uploadsforweek.php
    Added showTime in where sql clause.

2013-11-06
  slideshow-v1.08/js/slideshow.js
    Corrected GetInfo. I had data.appinfo but should be data.appInfo.

2013-11-07
  slideshow-v1.08/slideshow.ajax.php
    perRecent is now in appinfo not sites. Fixed in getItem().

  siteInfo.php
    Added warning about fields that will move to appinfo when v1.08 rolls out!
  
  appInfo.php
    Added warning about fields that will move to appinfo when v1.08 rolls out!

  NOTE: perRecent is not yet being handled by cpanel-v1.08. It must be changed manually via SQL.

2013-11-08
  index.php & track-startup.php
    Now if status is open but either lasttime is less then now minus 30 min or lasttime is null and
    starttime is less then 30 min we set the status to closed.

2013-11-09
  index.php
    Removed old slideshow 1.01-1.05 and cpanel 1.01-1.04.
    Also removed these old version from the server. The backup at
    /extra/myphotochannel-backups/mpc-November-09-2013.tar.gz has all of the old versions.

  cpanel-v1.08/cpanel.ajax.php, slideshow-v1.08/slideshow.ajax.php and emailphoto.php
    Removed the require 'require('websocket/vendor/pusher/pusher-php-server/lib/Pusher.php');'
    Copied Pusher.php to includes/.

  includes/
    Copied Pusher.php to includes/Pusher. Now the siteautoload.php will find it and we don't need
    to require it in emailphoto.php, cpanel.ajax.php, slideshow.ajax.php

  includes/README.txt
    Added a read me file to includes directory.

  includes/Tom.class.php
    Added some comments.

  pushercheck.php
    Added pusher status and show/hide button.

2013-11-11
  cpanel-v1.08/js/cpanel.showsettings.js
    Changed name to Photo History from Feature Ext.

2013-11-12
  Changed simlinks slideshow and cpanel to v1.08
  Created v1.09 slideshow and cpanel
  NOTE: as soon as the symlink are changed we start using slideshow.ajax.php and cpanel.ajax.php
  even though the sites may still be running v1.06. There should be no incompatabilities between
  these versions of the ajax files but some things will show up right away. For example the
  Pusher information will be for v1.08.

  index.php
    updated for current=v1.08 and added v1.09

  slideshow-v1.09/slideshow.ajax.php and js/slideshow.js
    added version to startup, unload and getItem for Pusher.

  cpanel-v1.09/cpanel.ajax.php and js/cpanel.js
    added version to startup, unload and getItem for Pusher.

2013-11-17
  index.php
    Ajax gettable altered select to use lasttime > date(now()) instead of starttime.

  emailphoto.php
    Added a try/catch to the insert to try to code with the 2006 "MySql server has gone away".
    We will see?

2013-11-18
  index
    Ajax gettable added status to the 'group by' clause.

  slideshow-v1.09/slideshow.php
    Tried some things but removed all changes. 

2013-11-19
  Changing the directory layout. From now on we will have version directories in the DOC_ROOT like:
  v1.08, v1.09 etc. We will still have slideshow and cpanel symlinks and also a new currentVersion
  symlink. The .htaccess will have RewriteRules to send / and index.php to currentVersion/index.php.
  emailphoto.php will have a RewriteRule to currentVersion/emailphoto.php and as will playLotto.php
  so the CRON does not need to change.

  include/Tom.class.php
    Added overloaded getPageHead() that figures the version number out and puts it in the <title> of
    the page head.

  v1.08/
    Created a directory v1.08 which has all of the PHP files that were in the DOC_ROOT along with
    symlinks slideshow and cpanel that point to /cpanel and /slideshow symlinks.

  v1.09/
    Created a directory v1.09 which has all of the PHP files that were in the DOC_ROOT along with
    copies of /cpanel-v1.09 and /slideshow-v1.09. 
    From now on all new versions will look like this:
    <version>/<all php files>
    <version>/slideshow/
    <version>/cpanel/

  v1.08 and v1.09/index.php
    Changed links to reflect new structure. 
    Changed lastModified() to reflect new structure.
    Currently v1.08 and v1.09 index.php are the same!

  TO-DO
    I would like to be able to show currentVersion root PHP's and also cutting edge root version
    PHP's. Maybe with a button or a URL flag?

2013-11-20
  v1.09/index.php
    Added select in a new div id=linkversion for current/working/old programs (TO-DO above).
    Added getlinkversion(), getversion() and Ajax entry point getlink.

  v1.09/js/index.js
    Added logic to add select and respond to select change and do ajax getlink call.

  Added symlinks for workingVersion to v1.09

  v1.08/slideshow/js/slideshow.js (which is really slideshow-v1.08/js/slideshow.js
  v1.09/slideshow/js/slideshow.js (whic is a real directory not symlinks)
    Changed the path to images/loading.gif to an absolute path /images/loading.gif
    also in v1.09 changed g.CONTENTPREFIX to '/' from '../'. In v1.08 that still works because of
    the simlinks.

  emailphoto.php and currentVersion and workingVersion.
    Fixed error $e.getCode() which should be $e->getCode().

  NOT-WORKING:
    slideshow v1.07 has path problem. This is OK in v1.08 and v1.09.
      I don't think I will mess with this as v1.07 is old news!
    itemsInfo.php v1.08 doesn't get info. (fixed below).
    slideshow direct to Felixs at bottom of page: (fixed below)
      "Go to the Home Page and follow the link
       Follow the link on the Home Page"

  currentVersion/itemsInfo.php (v1.08)
    Due to the change in cpanel-v1.08/cpanel.top.php superuser is now in $S->superuser not 
    $superuser. Made change. It was already changed in v1.09.
    Somehow I didn't document the cpanel.top.php change anywhere or the change to the v1.09
    version of v1.09 -- my bad!

  v1.08 and v1.09/index.php
    Fix NOT-WORKING item about slideshow direct. I didn't have the slideshow directory mentioned.

2013-11-21
  v1.08 & v1.09/index.php
    Added if(empty($_GET) && !$superuser) ... 
    I had added if(empty($_GET) yesterday but that broke the superuser cookie logic.

  include/database-engines/ dbMySqli.class.php dbAbstract.class.php
    added closeDb() to zero $db so next query will cause a new mysqli;

  v1.08/emailphoto.php
    testing to see if I can fix the database went away error. Changed crontab to use v1.08.
    Failed: changed crontab back to /emailphoto.php

  Need to fix index so clicking on clear log for database log doesn't zero emailphoto.log size. The
  actual file is not emptied?

2013-11-22
  crontab
    Cron now points to currentVersion of emailphoto.php

  v1.08/emailphoto.php
    Added more retry logic etc. I now check at the start to see if there is already an instance
    of the program running and if so just exit. Seems to be working OK now. Some times with
    large images it takes several minutes for the program to finish.

  v1.09/emailphoto.php   
    copied v1.08 to v1.09

2013-11-23
  cpanel.php
    Goes to homepage or cpanel-front-end.php

  slideshow.php
    Created. Goes to homepage or slideshow-front-end.php

  cpanel-front-end.php
    updated and added logo etc.

  slideshow-front-end.php
    created. Askes for siteCode, username, and password then goes to 
    slideshow/slideshow.php?siteCode=<siteCode>

  v1.07
    Added symlinks for ~/content and ~/images. 
    This fixes the error reported on 2013-11-20 NOT-WORKING

2013-11-24
  Added GIT repository to includes and v1.09.

  includes/database-engines/dbAbstract.class.php & dbMySqli.class.php
    Added closeDb() which does a mysqli::close().
    dbAbstract.class.php also does $this->db = null;

2013-12-04
  v1.08 & v1.08/slideshow/slideshow.php and cpanel/cpanel.top.php
    The version is now in the DOC_ROOT directory name which is vN.NN

2013-12-23
  v1.09/slideshow/playloto.php
    Added logic for skip days.

  SQL playlotto table. Added skipdays, skipdaysleft and date. New table format:
CREATE TABLE `playlotto` (
  `siteId` varchar(255) NOT NULL,
  `data` mediumtext,
  `expires` varchar(20) DEFAULT '+30 day',
  `game` int(2) DEFAULT '0',
  `period` int(11) DEFAULT '30',
  `skipdays` int(11) DEFAULT '0',
  `skipdaysleft` int(11) DEFAULT '0',
  `canPlay` int(11) DEFAULT '30',
  `date` date DEFAULT NULL,
  PRIMARY KEY (`siteId`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

-------------------------------------------------------
NEW YEAR
-------------------------------------------------------

2014-01-03
  track-startup.php restrict display to one week (7 day).

2014-01-10
  v1.09/emailphoto.php, v1.09/resize.php
  Now the emailphoto.php which runs every minute as a CRON job just gets the image from the email and
  writes it directly to the content/ directory and updates the items table. There is a new field,
  resized enum('no', 'yes') default 'no'. That field is set to 'no'. The image is the full size image
  that was emailed.
  resize.php runs as a CRON job every 30 minutes. It looks at the items table for any item that has
  resized='no'. It then resized the image and rewrite the items table. The resize.php writes to the
  ~/resize.log file.
  Added the new v1.09 versions to the crontab.
  
  v1.08/index.php v1.08/js/index.js
  Updated them by adding logic to look at the resize.log just like the other two logs.

2014-01-15
  v1.09/emailphoto.php: added more error logic to try and cope with the lost connection problem.

  includes/database-engines/dbAbstract.class.php & dbMysqli.class.php: added freeRequest() and in
  dbMysql.class.php I added fetchrow('obj') to fetch a row as an object.

  v1.09/resize.php: also added error logic like in emailphoto.php

2014-01-21
  v1.09/resize.php: Add error logic. If photo not found or a resize error mark the item inactive and
  press on. Also when we fetch resized='no' only look for status='active'.

  v1.09/emailphoto.php: Added echo each invocation for debugging. Only temp.

BLP 2014-02-28 -- 
Facebook login for Felixs
User:  facebook@felixsrestaurant.com
Pass:  Felix6335

BLP 2014-04-14 -- 
  Fixed playbingo and playlotto, and sites and appinfo tables. We had the playbingo and playlotto 
  field in both the sites and appinfo table. Originally I have the two fields in the sites table
  but later moved them into the appinfo table (I think that is where they belong). I didn't however
  remove them for the sites table at that time. The cpanel.games sets these fields in the appinfo
  table (as it should) BUT the photoloto.php was looking at the sites table to see if photo lotto 
  should play. I fixed this in photoloto.php.
  Also the playbingo and playlotto tables were not being initialized by the createNewSite.php program
  which could cause a problem if the appinfo.playlotto field was incorrectly set and there was NO
  entry in the playlotto table for the site. I fixed that also.

  cpanel.ajax.php: added $S->escape() where I thought it might be needed.

BLP 2014-07-15 -- 
  Added Total, Redeemed and % Redeemed to showlottowinners.php